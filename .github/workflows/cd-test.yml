name: CD Test

on:
   push:
      branches:
         - main
      paths:
         - 'package.json'
         - 'scripts/launcher.cjs'
         - 'scripts/postinstall.cjs'
         - '.github/workflows/cd-test.yml'
   workflow_dispatch:

jobs:
   pack:
      name: Build & Pack
      runs-on: ubuntu-latest
      steps:
         - name: Checkout
           uses: actions/checkout@v4

         # Wait for Test to succeed (only on push)
         - name: Wait for Test
           if: github.event_name == 'push'
           uses: lewagon/wait-on-check-action@v1.3.4
           with:
              ref: ${{ github.ref }}
              check-name: 'test'
              repo-token: ${{ secrets.GITHUB_TOKEN }}
              wait-interval: 10

         - name: Setup Bun
           uses: oven-sh/setup-bun@v2
           with:
              bun-version: latest

         - name: Install Dependencies
           run: bun install

         - name: Pack
           run: npm pack

         - name: Rename & Upload
           run: |
              mv gdx-*.tgz gdx-test.tgz
              curl -T gdx-test.tgz ${{ secrets.S3_GDX_BUCKET }}/gdx-test.tgz

   test-install:
      name: Test Install
      needs: pack
      runs-on: ${{ matrix.os }}
      strategy:
         matrix:
            os: [ubuntu-latest, macos-latest, windows-latest]

      steps:
         # install libsecret on linux
         - name: Install libsecret
           if: runner.os == 'Linux'
           uses: awalsh128/cache-apt-pkgs-action@latest
           with:
              packages: libsecret-1-dev
              version: 1.0

         - name: Setup Bun
           uses: oven-sh/setup-bun@v2
           with:
              bun-version: latest

         - name: Download Tarball
           shell: bash
           run: curl -o gdx-test.tgz ${{ secrets.S3_GDX_BUCKET }}/gdx-test.tgz

         - name: Test Install (Default/Node Fallback)
           shell: bash
           run: |
              npm install --loglevel verbose --foreground-scripts -g ./gdx-test.tgz
              # Verify it runs (should use node fallback)
              gdx doctor
              npm uninstall -g gdx

         - name: Test Install (Native Build)
           shell: bash
           run: |
              # Force native build
              export GDX_BUILD_NATIVE=1
              npm install --loglevel verbose --foreground-scripts -g ./gdx-test.tgz
              # Verify it runs (should use native binary)
              gdx doctor

              # Verify native binary exists
              NPM_ROOT=$(npm root -g)
              if [ "${{ runner.os }}" == "Windows" ]; then
                if [ ! -f "$NPM_ROOT/gdx/bin/native/gdx.exe" ]; then
                  echo "Native binary not found at $NPM_ROOT/gdx/bin/native/gdx.exe"
                  exit 1
                fi
              else
                if [ ! -f "$NPM_ROOT/gdx/bin/native/gdx" ]; then
                  echo "Native binary not found at $NPM_ROOT/gdx/bin/native/gdx"
                  exit 1
                fi
              fi
              npm uninstall -g gdx
